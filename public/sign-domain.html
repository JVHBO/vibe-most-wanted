<!DOCTYPE html>
<html>
<head>
  <title>Sign Domain - Farcaster</title>
  <style>
    body { background: #111; color: white; font-family: system-ui; padding: 40px; max-width: 600px; margin: 0 auto; }
    h1 { color: gold; }
    button { background: #7c3aed; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 10px 0; }
    button:hover { background: #6d28d9; }
    button:disabled { background: #444; cursor: not-allowed; }
    .result { background: #222; padding: 20px; border-radius: 8px; margin-top: 20px; word-break: break-all; }
    .info { color: #888; font-size: 14px; margin: 10px 0; }
    code { background: #333; padding: 2px 6px; border-radius: 4px; }
    pre { background: #1a1a1a; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px; }
    .success { color: #4ade80; }
    .error { color: #f87171; }
  </style>
</head>
<body>
  <h1>üîê Assinar Dom√≠nio para Farcaster</h1>

  <p class="info">
    Isso vai gerar o <code>accountAssociation</code> para o dom√≠nio <strong>vibemostwanted.xyz</strong> (sem www).
  </p>

  <p class="info">
    Wallet esperada: <code>0x2a9585Da40dE004d6Ff0f5F12cfe726BD2f98B52</code>
  </p>

  <button id="connectBtn" onclick="connectWallet()">1. Conectar Wallet</button>
  <p id="walletStatus" class="info"></p>

  <button id="signBtn" onclick="signMessage()" disabled>2. Assinar Mensagem</button>

  <div id="result" class="result" style="display: none;">
    <h3 class="success">‚úÖ Assinatura gerada!</h3>
    <p>Copie isso para usar no farcaster.json:</p>
    <pre id="output"></pre>
  </div>

  <script>
    const FID = 214746;
    const EXPECTED_ADDRESS = "0x2a9585Da40dE004d6Ff0f5F12cfe726BD2f98B52";
    const DOMAIN = "vibemostwanted.xyz";

    let userAddress = null;

    // Base64url encode
    function base64url(str) {
      return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    // Hex to base64
    function hexToBase64(hex) {
      const bytes = hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16));
      return btoa(String.fromCharCode(...bytes));
    }

    async function connectWallet() {
      if (typeof window.ethereum === 'undefined') {
        alert('MetaMask ou outra wallet n√£o encontrada!');
        return;
      }

      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAddress = accounts[0];

        const statusEl = document.getElementById('walletStatus');

        if (userAddress.toLowerCase() === EXPECTED_ADDRESS.toLowerCase()) {
          statusEl.innerHTML = `<span class="success">‚úÖ Conectado: ${userAddress}</span>`;
          document.getElementById('signBtn').disabled = false;
        } else {
          statusEl.innerHTML = `<span class="error">‚ùå Wallet errada: ${userAddress}<br>Esperado: ${EXPECTED_ADDRESS}</span>`;
          document.getElementById('signBtn').disabled = true;
        }
      } catch (error) {
        alert('Erro ao conectar: ' + error.message);
      }
    }

    async function signMessage() {
      if (!userAddress) {
        alert('Conecte a wallet primeiro!');
        return;
      }

      try {
        // Create header and payload
        const header = { fid: FID, type: "custody", key: EXPECTED_ADDRESS };
        const payload = { domain: DOMAIN };

        const headerB64 = base64url(JSON.stringify(header));
        const payloadB64 = base64url(JSON.stringify(payload));

        // Message to sign
        const message = `${headerB64}.${payloadB64}`;

        // Sign with wallet
        const signature = await window.ethereum.request({
          method: 'personal_sign',
          params: [message, userAddress]
        });

        // Convert signature to base64
        const sigBase64 = hexToBase64(signature.slice(2));

        // Show result
        const result = {
          header: headerB64,
          payload: payloadB64,
          signature: sigBase64
        };

        document.getElementById('output').textContent = JSON.stringify(result, null, 2);
        document.getElementById('result').style.display = 'block';

      } catch (error) {
        alert('Erro ao assinar: ' + error.message);
      }
    }
  </script>
</body>
</html>
